<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨ÙƒÙ„ Ø´ÙŠØ¡ Ù„Ù„ØªØ¬Ø±Ø¨Ø© -->
    <meta http-equiv="Content-Security-Policy" content="default-src * 'unsafe-inline' 'unsafe-eval' data: gap: content:;">
    
    <title>PI Detector Debug</title>
    
    <script src="cordova.js"></script>
    <script src="chart.js"></script>
    
    <style>
        body { background: #121212; color: #fff; font-family: sans-serif; padding: 10px; margin: 0; }
        .btn { background: #00e676; width: 100%; padding: 15px; font-size: 1.2em; border: none; border-radius: 8px; font-weight: bold; margin-bottom: 20px; }
        .status { text-align: center; font-size: 1.2em; margin-bottom: 20px; color: #888; }
        /* Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø£Ø³ÙˆØ¯ Ù„ÙƒØ´Ù Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ */
        #console-log {
            background: #000; color: #0f0; font-family: monospace; 
            padding: 10px; height: 300px; overflow-y: scroll; 
            border: 1px solid #333; font-size: 0.8em; text-align: left; direction: ltr;
        }
    </style>
</head>
<body>

    <h2 style="text-align: center; color: #00e676;">ÙˆØ¶Ø¹ Ø§Ù„ÙØ­Øµ (Debug)</h2>
    
    <div id="status">Ø¬Ø§Ø±ÙŠ ØªØ´ØºÙŠÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…...</div>

    <!-- Ø§Ù„Ø²Ø± Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ -->
    <button id="connectBtn" class="btn">Ø§Ø¶ØºØ· Ù„Ù„Ø§ØªØµØ§Ù„ (USB)</button>

    <h3>Ø³Ø¬Ù„ Ø§Ù„Ù†Ø¸Ø§Ù… (System Log):</h3>
    <div id="console-log">Waiting for logs...<br></div>

    <script>
        // --- 1. Ù†Ø¸Ø§Ù… ÙƒØ´Ù Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ù…Ø±Ø¦ÙŠ ---
        function log(msg) {
            var logBox = document.getElementById('console-log');
            var time = new Date().toLocaleTimeString();
            logBox.innerHTML += `<span style="color:#555">[${time}]</span> ${msg}<br>`;
            logBox.scrollTop = logBox.scrollHeight; // Ø§Ù„ØªÙ…Ø±ÙŠØ± Ù„Ù„Ø£Ø³ÙÙ„
        }

        // Ø§Ù„ØªÙ‚Ø§Ø· Ø£ÙŠ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ÙƒÙˆØ¯ ÙˆØ¹Ø±Ø¶Ù‡
        window.onerror = function(msg, url, line) {
            log(`<span style="color:red">ERROR: ${msg} (Line: ${line})</span>`);
            return false;
        };

        log("App started. Waiting for DeviceReady...");

        // --- 2. Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù… ---
        var serial = null;

        // --- 3. ØªØ¬Ù‡ÙŠØ² Cordova ---
        document.addEventListener("deviceready", function() {
            log("âœ… DeviceReady Event Fired!");
            
            // ÙØ­Øµ ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø¥Ø¶Ø§ÙØ©
            if (cordova.plugins && cordova.plugins.serial) {
                serial = cordova.plugins.serial;
                log("âœ… Plugin 'cordovarduino' FOUND!");
                document.getElementById('status').innerText = "Ø§Ù„Ù†Ø¸Ø§Ù… Ø¬Ø§Ù‡Ø². Ø§Ø¶ØºØ· Ø§ØªØµØ§Ù„.";
                document.getElementById('status').style.color = "white";
            } else {
                log("âŒ CRITICAL: Plugin NOT found.");
                log("Check: cordovarduino plugin installation.");
                log("Keys available: " + Object.keys(cordova.plugins || {}));
                document.getElementById('status').innerText = "Ø®Ø·Ø£: Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ù…ÙÙ‚ÙˆØ¯Ø©";
                document.getElementById('status').style.color = "red";
            }
        }, false);

        // --- 4. Ø¨Ø±Ù…Ø¬Ø© Ø§Ù„Ø²Ø± (ØªØ¬Ø§ÙˆØ²Ù†Ø§ onclick ÙÙŠ HTML) ---
        document.getElementById('connectBtn').addEventListener('click', function() {
            log("ğŸ–± Button Clicked.");
            
            if (!serial) {
                log("âš ï¸ Serial object is null. Cannot connect.");
                alert("Ø®Ø·Ø£: Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø¥Ø¶Ø§ÙØ© USB");
                return;
            }

            log("Requesting USB Permission...");
            
            serial.requestPermission(
                function(success) {
                    log("âœ… Permission GRANTED by user.");
                    openPort();
                },
                function(error) {
                    log("âŒ Permission DENIED/Error: " + JSON.stringify(error));
                    alert("ÙØ´Ù„ Ø§Ù„Ø¥Ø°Ù†: " + error);
                }
            );
        });

        function openPort() {
            log("Attempting to open port (115200)...");
            serial.open(
                { baudRate: 115200 },
                function(success) {
                    log("ğŸŸ¢ PORT OPENED SUCCESSFULLY!");
                    document.getElementById('status').innerText = "Ù…ØªØµÙ„ (Connected)";
                    document.getElementById('status').style.color = "#00e676";
                    alert("ØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù†Ø¬Ø§Ø­!");
                    
                    // ØªØ¬Ø±Ø¨Ø© Ù‚Ø±Ø§Ø¡Ø©
                    startRead();
                },
                function(error) {
                    log("âŒ Failed to open port: " + error);
                }
            );
        }

        function startRead() {
            log("Registering Read Callback...");
            serial.registerReadCallback(
                function(data) {
                    // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù†Øµ Ù„Ø¹Ø±Ø¶Ù‡Ø§
                    var view = new Uint8Array(data);
                    // Ø¹Ø±Ø¶ Ø£ÙˆÙ„ 10 Ø¨Ø§ÙŠØª ÙÙ‚Ø· Ù„Ù„ØªØ¬Ø±Ø¨Ø©
                    log("DATA IN: " + view.length + " bytes");
                },
                function(error) {
                    log("Read Error: " + error);
                }
            );
        }

    </script>
</body>
</html>
